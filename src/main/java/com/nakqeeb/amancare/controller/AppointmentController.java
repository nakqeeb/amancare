// =============================================================================
// Appointment Controller - ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
// =============================================================================

package com.nakqeeb.amancare.controller;

import com.nakqeeb.amancare.annotation.SystemAdminContext;
import com.nakqeeb.amancare.dto.request.CreateAppointmentRequest;
import com.nakqeeb.amancare.dto.request.UpdateAppointmentRequest;
import com.nakqeeb.amancare.dto.response.*;
import com.nakqeeb.amancare.entity.AppointmentStatus;
import com.nakqeeb.amancare.entity.UserRole;
import com.nakqeeb.amancare.security.UserPrincipal;
import com.nakqeeb.amancare.service.AppointmentService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.ExampleObject;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDate;
import java.util.List;

/**
 * ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
 */
@RestController
@RequestMapping("/appointments")
@Tag(name = "ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯", description = "APIs Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø¥Ø¯Ø§Ø±Ø© Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©")
@CrossOrigin(origins = "*", maxAge = 3600)
public class AppointmentController {
    private static final Logger logger = LoggerFactory.getLogger(AppointmentController.class);

    @Autowired
    private AppointmentService appointmentService;

    /**
     * Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯
     */
    @PostMapping
    @SystemAdminContext
    @PreAuthorize("hasRole('SYSTEM_ADMIN') or hasRole('ADMIN') or hasRole('DOCTOR') or hasRole('RECEPTIONIST')")
    @Operation(
            summary = "â• Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯",
            description = "Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø±ÙŠØ¶ Ù…Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø§Ø±Ø¶",
            requestBody = @io.swagger.v3.oas.annotations.parameters.RequestBody(
                    content = @Content(
                            examples = @ExampleObject(
                                    name = "Ù…Ø«Ø§Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ¹Ø¯",
                                    value = """
                        {
                          "patientId": 1,
                          "doctorId": 2,
                          "appointmentDate": "2024-08-28",
                          "appointmentTime": "10:30:00",
                          "durationMinutes": 30,
                          "appointmentType": "CONSULTATION",
                          "chiefComplaint": "Ø£Ù„Ù… ÙÙŠ Ø§Ù„ØµØ¯Ø± ÙˆØµØ¹ÙˆØ¨Ø© ÙÙŠ Ø§Ù„ØªÙ†ÙØ³",
                          "notes": "Ø§Ù„Ù…Ø±ÙŠØ¶ ÙŠØ´ÙƒÙˆ Ù…Ù† Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ù…Ù†Ø° Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†"
                        }
                        """
                            )
                    )
            )
    )
    @ApiResponses(value = {
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "201", description = "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "400", description = "Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "404", description = "Ø§Ù„Ù…Ø±ÙŠØ¶ Ø£Ùˆ Ø§Ù„Ø·Ø¨ÙŠØ¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "409", description = "ÙŠÙˆØ¬Ø¯ ØªØ¹Ø§Ø±Ø¶ Ù…Ø¹ Ù…ÙˆØ¹Ø¯ Ø¢Ø®Ø±"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "401", description = "ØºÙŠØ± Ù…ØµØ±Ø­ - ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "403", description = "Ù…Ù…Ù†ÙˆØ¹ - ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©")
    })
    public ResponseEntity<ApiResponse<AppointmentResponse>> createAppointment(
            @AuthenticationPrincipal UserPrincipal currentUser,
            @Valid @RequestBody CreateAppointmentRequest request) {
        try {
            AppointmentResponse appointment = appointmentService.createAppointment(
                    currentUser.getClinicId(), currentUser.getId(), request);
            return ResponseEntity.status(HttpStatus.CREATED)
                    .body(new ApiResponse<>(true, "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­", appointment));
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST)
                    .body(new ApiResponse<>(false, "ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¹Ø¯: " + e.getMessage(), null));
        }
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…Ø¹ Ø§Ù„ØªØµÙÙŠØ©
     */
    @GetMapping
    @PreAuthorize("hasRole('SYSTEM_ADMIN') or hasRole('ADMIN') or hasRole('DOCTOR') or hasRole('NURSE') or hasRole('RECEPTIONIST')")
    @Operation(
            summary = "ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯",
            description = "Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØµÙÙŠØ© Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø·Ø¨ÙŠØ¨ ÙˆØ§Ù„Ø­Ø§Ù„Ø©"
    )
    @ApiResponses(value = {
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "200", description = "ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "401", description = "ØºÙŠØ± Ù…ØµØ±Ø­ - ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "403", description = "Ù…Ù…Ù†ÙˆØ¹ - ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©")
    })
    public ResponseEntity<ApiResponse<AppointmentPageResponse>> getAllAppointments(
            @AuthenticationPrincipal UserPrincipal currentUser,
            @Parameter(description = "Ù…Ø¹Ø±Ù Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© (Ù„Ù„Ù€ SYSTEM_ADMIN ÙÙ‚Ø·)")
            @RequestParam(required = false) Long clinicId,
            @Parameter(description = "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯", example = "2024-08-28")
            @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate date,
            @Parameter(description = "Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ø¨ÙŠØ¨", example = "2")
            @RequestParam(required = false) Long doctorId,
            @Parameter(description = "Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯", example = "SCHEDULED")
            @RequestParam(required = false) AppointmentStatus status,
            @Parameter(description = "Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø© (ÙŠØ¨Ø¯Ø£ Ù…Ù† 0)", example = "0")
            @RequestParam(defaultValue = "0") int page,
            @Parameter(description = "Ø­Ø¬Ù… Ø§Ù„ØµÙØ­Ø©", example = "10")
            @RequestParam(defaultValue = "10") int size,
            @Parameter(description = "ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨", example = "appointmentDate")
            @RequestParam(defaultValue = "appointmentDate") String sortBy,
            @Parameter(description = "Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØªØ±ØªÙŠØ¨", example = "asc")
            @RequestParam(defaultValue = "asc") String sortDirection) {
        try {
            // For READ operations, SYSTEM_ADMIN doesn't need context
            Long effectiveClinicId;
            if (UserRole.SYSTEM_ADMIN.name().equals(currentUser.getRole())) {
                // SYSTEM_ADMIN can specify clinic or get all
                effectiveClinicId = clinicId; // Can be null to get all clinics
                logger.info("SYSTEM_ADMIN reading appointments from clinic: {}",
                        clinicId != null ? clinicId : "ALL");
            } else {
                // Other users can only see their clinic
                effectiveClinicId = currentUser.getClinicId();
            }
            AppointmentPageResponse appointments = appointmentService.getAllAppointments(
                    effectiveClinicId, date, doctorId, status, page, size, sortBy, sortDirection
            );
            return ResponseEntity.ok(
                    new ApiResponse<>(true, "ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­", appointments)
            );
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(new ApiResponse<>(false, "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯: " + e.getMessage(), null));
        }
    }

    /**
     * Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…
     */
    @GetMapping("/today")
    @PreAuthorize("hasRole('SYSTEM_ADMIN') or hasRole('ADMIN') or hasRole('DOCTOR') or hasRole('NURSE') or hasRole('RECEPTIONIST')")
    @Operation(
            summary = "ğŸ“… Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…",
            description = "Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø© Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ"
    )
    @ApiResponses(value = {
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "200", description = "ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "401", description = "ØºÙŠØ± Ù…ØµØ±Ø­ - ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "403", description = "Ù…Ù…Ù†ÙˆØ¹ - ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©")
    })
    public ResponseEntity<ApiResponse<List<AppointmentSummaryResponse>>> getTodayAppointments(
            @AuthenticationPrincipal UserPrincipal currentUser,
            @Parameter(description = "Ù…Ø¹Ø±Ù Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© (Ù„Ù„Ù€ SYSTEM_ADMIN ÙÙ‚Ø·)")
            @RequestParam(required = false) Long clinicId) {
        try {
            // For READ operations, SYSTEM_ADMIN doesn't need context
            Long effectiveClinicId;
            if (UserRole.SYSTEM_ADMIN.name().equals(currentUser.getRole())) {
                // SYSTEM_ADMIN can specify clinic or get all
                effectiveClinicId = clinicId; // Can be null to get all clinics
                logger.info("SYSTEM_ADMIN reading today's appointments from clinic: {}",
                        clinicId != null ? clinicId : "ALL");
            } else {
                // Other users can only see their clinic
                effectiveClinicId = currentUser.getClinicId();
            }
            List<AppointmentSummaryResponse> todayAppointments = appointmentService.getTodayAppointments(
                    effectiveClinicId);
            return ResponseEntity.ok(
                    new ApiResponse<>(true, "ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­", todayAppointments)
            );
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(new ApiResponse<>(false, "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…: " + e.getMessage(), null));
        }
    }

    /**
     * Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø·Ø¨ÙŠØ¨ Ù…Ø¹ÙŠÙ†
     */
    @GetMapping("/doctor/{doctorId}")
    @PreAuthorize("hasRole('SYSTEM_ADMIN') or hasRole('ADMIN') or hasRole('DOCTOR') or hasRole('NURSE') or hasRole('RECEPTIONIST')")
    @Operation(
            summary = "ğŸ‘¨â€âš•ï¸ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø·Ø¨ÙŠØ¨",
            description = "Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø·Ø¨ÙŠØ¨ Ù…Ø¹ÙŠÙ† ÙÙŠ ØªØ§Ø±ÙŠØ® Ù…Ø­Ø¯Ø¯ Ø£Ùˆ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ"
    )
    @ApiResponses(value = {
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "200", description = "ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø¨Ù†Ø¬Ø§Ø­"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "404", description = "Ø§Ù„Ø·Ø¨ÙŠØ¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "401", description = "ØºÙŠØ± Ù…ØµØ±Ø­ - ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "403", description = "Ù…Ù…Ù†ÙˆØ¹ - ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©")
    })
    public ResponseEntity<ApiResponse<List<AppointmentSummaryResponse>>> getDoctorAppointments(
            @AuthenticationPrincipal UserPrincipal currentUser,
            @Parameter(description = "Ù…Ø¹Ø±Ù Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© (Ù„Ù„Ù€ SYSTEM_ADMIN ÙÙ‚Ø·)")
            @RequestParam(required = false) Long clinicId,
            @Parameter(description = "Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ø¨ÙŠØ¨", example = "2")
            @PathVariable Long doctorId,
            @Parameter(description = "Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ØŒ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…)", example = "2024-08-28")
            @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate date) {
        try {
            // For READ operations, SYSTEM_ADMIN doesn't need context
            Long effectiveClinicId;
            if (UserRole.SYSTEM_ADMIN.name().equals(currentUser.getRole())) {
                // SYSTEM_ADMIN can specify clinic or get all
                effectiveClinicId = clinicId; // Can be null to get all clinics
                logger.info("SYSTEM_ADMIN reading a doctor's appointments from clinic: {}",
                        clinicId != null ? clinicId : "ALL");
            } else {
                // Other users can only see their clinic
                effectiveClinicId = currentUser.getClinicId();
            }
            List<AppointmentSummaryResponse> doctorAppointments = appointmentService.getDoctorAppointments(
                    effectiveClinicId, doctorId, date);
            return ResponseEntity.ok(
                    new ApiResponse<>(true, "ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø¨Ù†Ø¬Ø§Ø­", doctorAppointments)
            );
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.NOT_FOUND)
                    .body(new ApiResponse<>(false, "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø·Ø¨ÙŠØ¨: " + e.getMessage(), null));
        }
    }

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆØ¹Ø¯ Ù…Ø­Ø¯Ø¯
     */
    @GetMapping("/{id}")
    @PreAuthorize("hasRole('SYSTEM_ADMIN') or hasRole('ADMIN') or hasRole('DOCTOR') or hasRole('NURSE') or hasRole('RECEPTIONIST')")
    @Operation(
            summary = "ğŸ” ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯",
            description = "Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ù…ÙˆØ¹Ø¯ Ù…Ø­Ø¯Ø¯"
    )
    @ApiResponses(value = {
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "200", description = "ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "404", description = "Ø§Ù„Ù…ÙˆØ¹Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "401", description = "ØºÙŠØ± Ù…ØµØ±Ø­ - ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "403", description = "Ù…Ù…Ù†ÙˆØ¹ - ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©")
    })
    public ResponseEntity<ApiResponse<AppointmentResponse>> getAppointmentById(
            @AuthenticationPrincipal UserPrincipal currentUser,
            @Parameter(description = "Ù…Ø¹Ø±Ù Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© (Ù„Ù„Ù€ SYSTEM_ADMIN ÙÙ‚Ø·)")
            @RequestParam(required = false) Long clinicId,
            @Parameter(description = "Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙˆØ¹Ø¯", example = "1")
            @PathVariable Long id) {
        try {
            // For READ operations, SYSTEM_ADMIN doesn't need context
            Long effectiveClinicId;
            if (UserRole.SYSTEM_ADMIN.name().equals(currentUser.getRole())) {
                // SYSTEM_ADMIN can specify clinic or get all
                effectiveClinicId = clinicId; // Can be null to get all clinics
                logger.info("SYSTEM_ADMIN reading a specific appointment from clinic: {}",
                        clinicId != null ? clinicId : "ALL");
            } else {
                // Other users can only see their clinic
                effectiveClinicId = currentUser.getClinicId();
            }
            AppointmentResponse appointment = appointmentService.getAppointmentById(effectiveClinicId, id);
            return ResponseEntity.ok(
                    new ApiResponse<>(true, "ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­", appointment)
            );
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.NOT_FOUND)
                    .body(new ApiResponse<>(false, "Ø§Ù„Ù…ÙˆØ¹Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: " + e.getMessage(), null));
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ¹Ø¯
     */
    @PutMapping("/{id}")
    @SystemAdminContext
    @PreAuthorize("hasRole('SYSTEM_ADMIN') or hasRole('ADMIN') or hasRole('DOCTOR') or hasRole('RECEPTIONIST')")
    @Operation(
            summary = "âœï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¹Ø¯",
            description = "ØªØ­Ø¯ÙŠØ« ØªÙØ§ØµÙŠÙ„ Ù…ÙˆØ¹Ø¯ Ù…ÙˆØ¬ÙˆØ¯ (Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ø§Ù„ÙˆÙ‚ØªØŒ Ø§Ù„Ù†ÙˆØ¹ØŒ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª)",
            requestBody = @io.swagger.v3.oas.annotations.parameters.RequestBody(
                    content = @Content(
                            examples = @ExampleObject(
                                    name = "Ù…Ø«Ø§Ù„ ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ¹Ø¯",
                                    value = """
                        {
                          "appointmentDate": "2024-08-29",
                          "appointmentTime": "14:30:00",
                          "durationMinutes": 45,
                          "appointmentType": "FOLLOW_UP",
                          "chiefComplaint": "Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„ØªØ­Ø³Ù†",
                          "notes": "Ø§Ù„Ù…Ø±ÙŠØ¶ ÙŠØ´Ø¹Ø± Ø¨ØªØ­Ø³Ù† Ù…Ù„Ø­ÙˆØ¸ Ù…Ù†Ø° Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©"
                        }
                        """
                            )
                    )
            )
    )
    @ApiResponses(value = {
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "200", description = "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "400", description = "Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "404", description = "Ø§Ù„Ù…ÙˆØ¹Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "409", description = "ÙŠÙˆØ¬Ø¯ ØªØ¹Ø§Ø±Ø¶ Ù…Ø¹ Ù…ÙˆØ¹Ø¯ Ø¢Ø®Ø±"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "401", description = "ØºÙŠØ± Ù…ØµØ±Ø­ - ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "403", description = "Ù…Ù…Ù†ÙˆØ¹ - ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©")
    })
    public ResponseEntity<ApiResponse<AppointmentResponse>> updateAppointment(
            @AuthenticationPrincipal UserPrincipal currentUser,
            @Parameter(description = "Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙˆØ¹Ø¯", example = "1")
            @PathVariable Long id,
            @Valid @RequestBody UpdateAppointmentRequest request) {
        try {
            AppointmentResponse appointment = appointmentService.updateAppointment(
                    currentUser.getClinicId(), id, request);
            return ResponseEntity.ok(
                    new ApiResponse<>(true, "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­", appointment)
            );
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST)
                    .body(new ApiResponse<>(false, "ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¹Ø¯: " + e.getMessage(), null));
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯
     */
    @PatchMapping("/{id}/status")
    @SystemAdminContext
    @PreAuthorize("hasRole('SYSTEM_ADMIN') or hasRole('ADMIN') or hasRole('DOCTOR') or hasRole('NURSE') or hasRole('RECEPTIONIST')")
    @Operation(
            summary = "ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯",
            description = "ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯ (Ù…Ø¬Ø¯ÙˆÙ„ØŒ Ù…Ø¤ÙƒØ¯ØŒ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°ØŒ Ù…ÙƒØªÙ…Ù„ØŒ Ù…Ù„ØºÙŠØŒ Ù„Ù… ÙŠØ­Ø¶Ø±)"
    )
    @ApiResponses(value = {
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "200", description = "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "400", description = "Ø§Ù†ØªÙ‚Ø§Ù„ ØºÙŠØ± ØµØ­ÙŠØ­ Ù„Ù„Ø­Ø§Ù„Ø©"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "404", description = "Ø§Ù„Ù…ÙˆØ¹Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "401", description = "ØºÙŠØ± Ù…ØµØ±Ø­ - ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "403", description = "Ù…Ù…Ù†ÙˆØ¹ - ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©")
    })
    public ResponseEntity<ApiResponse<AppointmentResponse>> updateAppointmentStatus(
            @AuthenticationPrincipal UserPrincipal currentUser,
            @Parameter(description = "Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙˆØ¹Ø¯", example = "1")
            @PathVariable Long id,
            @Parameter(description = "Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", example = "COMPLETED")
            @RequestParam AppointmentStatus status) {
        try {
            AppointmentResponse appointment = appointmentService.updateAppointmentStatus(
                    currentUser.getClinicId(), id, status);
            return ResponseEntity.ok(
                    new ApiResponse<>(true, "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­", appointment)
            );
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST)
                    .body(new ApiResponse<>(false, "ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯: " + e.getMessage(), null));
        }
    }

    /**
     * Ø¥Ù„ØºØ§Ø¡ Ù…ÙˆØ¹Ø¯
     */
    @DeleteMapping("/{id}")
    @SystemAdminContext
    @PreAuthorize("hasRole('SYSTEM_ADMIN') or hasRole('ADMIN') or hasRole('DOCTOR') or hasRole('RECEPTIONIST')")
    @Operation(
            summary = "âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ÙˆØ¹Ø¯",
            description = "Ø¥Ù„ØºØ§Ø¡ Ù…ÙˆØ¹Ø¯ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡"
    )
    @ApiResponses(value = {
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "200", description = "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "400", description = "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ÙˆØ¹Ø¯"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "404", description = "Ø§Ù„Ù…ÙˆØ¹Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "401", description = "ØºÙŠØ± Ù…ØµØ±Ø­ - ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "403", description = "Ù…Ù…Ù†ÙˆØ¹ - ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©")
    })
    public ResponseEntity<ApiResponse<Void>> cancelAppointment(
            @AuthenticationPrincipal UserPrincipal currentUser,
            @Parameter(description = "Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙˆØ¹Ø¯", example = "1")
            @PathVariable Long id,
            @Parameter(description = "Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ù„ØºØ§Ø¡", example = "Ø§Ù„Ù…Ø±ÙŠØ¶ ØºÙŠØ± Ù‚Ø§Ø¯Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¶ÙˆØ±")
            @RequestParam(required = false) String reason) {
        try {
            appointmentService.cancelAppointment(currentUser.getClinicId(), id, reason);
            return ResponseEntity.ok(
                    new ApiResponse<>(true, "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­", null)
            );
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST)
                    .body(new ApiResponse<>(false, "ÙØ´Ù„ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ÙˆØ¹Ø¯: " + e.getMessage(), null));
        }
    }

    /**
     * Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù„Ù„Ù…Ø±ÙŠØ¶
     */
    @GetMapping("/patient/{patientId}/upcoming")
    @PreAuthorize("hasRole('SYSTEM_ADMIN') or hasRole('ADMIN') or hasRole('DOCTOR') or hasRole('NURSE') or hasRole('RECEPTIONIST')")
    @Operation(
            summary = "â­ï¸ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù„Ù„Ù…Ø±ÙŠØ¶",
            description = "Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù„Ù…Ø±ÙŠØ¶ Ù…Ø¹ÙŠÙ†"
    )
    @ApiResponses(value = {
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "200", description = "ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "404", description = "Ø§Ù„Ù…Ø±ÙŠØ¶ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "401", description = "ØºÙŠØ± Ù…ØµØ±Ø­ - ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "403", description = "Ù…Ù…Ù†ÙˆØ¹ - ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©")
    })
    public ResponseEntity<ApiResponse<List<AppointmentSummaryResponse>>> getUpcomingAppointmentsByPatient(
            @AuthenticationPrincipal UserPrincipal currentUser,
            @Parameter(description = "Ù…Ø¹Ø±Ù Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© (Ù„Ù„Ù€ SYSTEM_ADMIN ÙÙ‚Ø·)")
            @RequestParam(required = false) Long clinicId,
            @Parameter(description = "Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±ÙŠØ¶", example = "1")
            @PathVariable Long patientId) {
        try {
            // For READ operations, SYSTEM_ADMIN doesn't need context
            Long effectiveClinicId;
            if (UserRole.SYSTEM_ADMIN.name().equals(currentUser.getRole())) {
                // SYSTEM_ADMIN can specify clinic or get all
                effectiveClinicId = clinicId; // Can be null to get all clinics
                logger.info("SYSTEM_ADMIN reading upcoming appointments for a specific patients from clinic: {}",
                        clinicId != null ? clinicId : "ALL");
            } else {
                // Other users can only see their clinic
                effectiveClinicId = currentUser.getClinicId();
            }
            List<AppointmentSummaryResponse> upcomingAppointments = appointmentService.getUpcomingAppointmentsByPatient(
                    effectiveClinicId, patientId);
            return ResponseEntity.ok(
                    new ApiResponse<>(true, "ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­", upcomingAppointments)
            );
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.NOT_FOUND)
                    .body(new ApiResponse<>(false, "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: " + e.getMessage(), null));
        }
    }

    /**
     * Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©
     */
    @GetMapping("/overdue")
    @PreAuthorize("hasRole('SYSTEM_ADMIN') or hasRole('ADMIN') or hasRole('DOCTOR')")
    @Operation(
            summary = "â° Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©",
            description = "Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ØªÙŠ ÙØ§Øª Ù…ÙˆØ¹Ø¯Ù‡Ø§ ÙˆÙ„Ù… ÙŠØªÙ… Ø¥ÙƒÙ…Ø§Ù„Ù‡Ø§ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¤Ù‡Ø§"
    )
    @ApiResponses(value = {
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "200", description = "ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "401", description = "ØºÙŠØ± Ù…ØµØ±Ø­ - ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "403", description = "Ù…Ù…Ù†ÙˆØ¹ - Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø£Ùˆ Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙÙ‚Ø·")
    })
    public ResponseEntity<ApiResponse<List<AppointmentSummaryResponse>>> getOverdueAppointments(
            @AuthenticationPrincipal UserPrincipal currentUser,
            @Parameter(description = "Ù…Ø¹Ø±Ù Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© (Ù„Ù„Ù€ SYSTEM_ADMIN ÙÙ‚Ø·)")
            @RequestParam(required = false) Long clinicId) {
        try {
            // For READ operations, SYSTEM_ADMIN doesn't need context
            Long effectiveClinicId;
            if (UserRole.SYSTEM_ADMIN.name().equals(currentUser.getRole())) {
                // SYSTEM_ADMIN can specify clinic or get all
                effectiveClinicId = clinicId; // Can be null to get all clinics
                logger.info("SYSTEM_ADMIN reading past, uncompleted, or canceled appointments from clinic: {}",
                        clinicId != null ? clinicId : "ALL");
            } else {
                // Other users can only see their clinic
                effectiveClinicId = currentUser.getClinicId();
            }
            List<AppointmentSummaryResponse> overdueAppointments = appointmentService.getOverdueAppointments(
                    effectiveClinicId);
            return ResponseEntity.ok(
                    new ApiResponse<>(true, "ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­", overdueAppointments)
            );
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(new ApiResponse<>(false, "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©: " + e.getMessage(), null));
        }
    }

    /**
     * Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
     */
    @GetMapping("/statistics")
    @PreAuthorize("hasRole('SYSTEM_ADMIN') or hasRole('ADMIN') or hasRole('DOCTOR')")
    @Operation(
            summary = "ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯",
            description = "Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù„ØªØ§Ø±ÙŠØ® Ù…Ø¹ÙŠÙ† Ø£Ùˆ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ"
    )
    @ApiResponses(value = {
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "200", description = "ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "401", description = "ØºÙŠØ± Ù…ØµØ±Ø­ - ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"),
            @io.swagger.v3.oas.annotations.responses.ApiResponse(responseCode = "403", description = "Ù…Ù…Ù†ÙˆØ¹ - Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø£Ùˆ Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙÙ‚Ø·")
    })
    public ResponseEntity<ApiResponse<AppointmentStatistics>> getAppointmentStatistics(
            @AuthenticationPrincipal UserPrincipal currentUser,
            @Parameter(description = "Ù…Ø¹Ø±Ù Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© (Ù„Ù„Ù€ SYSTEM_ADMIN ÙÙ‚Ø·)")
            @RequestParam(required = false) Long clinicId,
            @Parameter(description = "Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ØŒ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…)", example = "2024-08-28")
            @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate date) {
        try {
            // For READ operations, SYSTEM_ADMIN doesn't need context
            Long effectiveClinicId;
            if (UserRole.SYSTEM_ADMIN.name().equals(currentUser.getRole())) {
                // SYSTEM_ADMIN can specify clinic or get all
                effectiveClinicId = clinicId; // Can be null to get all clinics
                logger.info("SYSTEM_ADMIN reading appointments statistics from clinic: {}",
                        clinicId != null ? clinicId : "ALL");
            } else {
                // Other users can only see their clinic
                effectiveClinicId = currentUser.getClinicId();
            }
            AppointmentStatistics statistics = appointmentService.getAppointmentStatistics(
                    effectiveClinicId, date);
            return ResponseEntity.ok(
                    new ApiResponse<>(true, "ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­", statistics)
            );
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(new ApiResponse<>(false, "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: " + e.getMessage(), null));
        }
    }
}